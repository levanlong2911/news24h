---
import { splitParagraphsWithAds } from "../utils/html.utils.ts";
import { extractScripts } from "../utils/ads.utils.ts";
import PositionAd from "./PositionAd.astro";
import TableWrapper from "../components/TableWrapper.astro";
import type { Post } from "../types.ts";
import { fetchAds } from "../lib/api";
import { injectInPostAds } from "../lib/injectInPostAds";
import type { AdsMap } from "../types/ads"

const { post, relatedPosts, ads } = Astro.props as {
  post: Post;
  relatedPosts: Post[];
  ads: AdsMap;
};
const inPostAds = ads?.["in-post"] || [];

// ðŸ¤– BOT â†’ NO ADS (SEO CLEAN)
const ua = Astro.request.headers.get("user-agent") || "";
const isBot = /googlebot|bingbot|yandex|duckduckbot|baiduspider/i.test(ua);

// ULTRA PROMAX: inject in-post ads (USER ONLY)
const contentParts = injectInPostAds(
  post.content,
  inPostAds,
  3
);
---

<section id="content">
  <div class="detail-title">
    <h1>{post.title}</h1>
  </div>

  <div class="detail-infor">
    <p>
      {post.admin?.name || "Admin"} |
      {new Date(post.updated_at).toLocaleDateString("en-US", {
          day: "numeric",
          month: "long",
          year: "numeric",
        })} |
      {post.category?.name}
    </p>
  </div>

  <div class="detail-content">
    <article class="post-body">
      {
        contentParts.map((item, index) =>
          item.type === "html" ? (
            <TableWrapper key={index} htmlContent={item.content} />
          ) : (
            <div
              class="ad-slot"
              data-ad-id={index}
              data-ad-script={encodeURIComponent(item.content)}
            />
          )
        )
      }
    </article>
  </div>
  <!-- bottom ads -->
  {ads.bottom?.length > 0 && <PositionAd position="bottom" ads={ads} />}
</section>

<section class="related-posts">
  <div class="section-title">
    <h2>Related Posts</h2>
  </div>
  <div class="related-grid">
    {
      relatedPosts.slice(0, 6).map((item) => (
        <div class="related-item" key={item.id}>
          <a href={`/post/${item.slug}`}>
            <img
              src={item.thumbnail}
              alt={item.title}
              class="related-img"
            />
            <h3 class="related-title">{item.title}</h3>
          </a>
        </div>
      ))
    }
  </div>
</section>

