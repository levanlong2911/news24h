---
import { splitParagraphsWithAds } from "../utils/html.utils.ts";
import { extractScripts } from "../utils/ads.utils.ts";
import PositionAd from "../components/PositionAd.astro";
import TableWrapper from "../components/TableWrapper.astro";
import type { Post } from "../types.ts";
import { useAds } from "../lib/useAds";

// const { post, relatedPosts }: { post: Post; relatedPosts: Post[] } =
//   Astro.props;

// // Fetch ads
// let adsHtml: string[] = [];
// try {
//   const res = await fetch(
//     `https://admin.lifennew.com/api/ads?position=in-post`
//   );
//   if (res.ok) {
//     const json = await res.json();
//     adsHtml = json.data.map((ad) => extractScripts(ad.script).bodyHtml);
//   }
// } catch (err) {
//   console.error("Failed to fetch in-post ads:", err);
// }
// ðŸ”¥ 1 request duy nháº¥t
// const ads = await useAds();

// // In-post ads
// const inPostAds = (ads["in-post"] || []).map(
//   (ad) => extractScripts(ad.script).bodyHtml
// );


// Split paragraphs & insert ads every 3 <p>
// const contentParts = splitParagraphsWithAds(post.content, inPostAds, 3);

const { post, relatedPosts, ads } = Astro.props;

// In-post ads
const inPostAds = (ads?.["in-post"] || []).map(
  (ad) => extractScripts(ad.script).bodyHtml
);

const contentParts = splitParagraphsWithAds(
  post.content,
  inPostAds,
  3
);
---

<section id="content">
  <div class="detail-title">
    <h1>{post.title}</h1>
  </div>

  <div class="detail-infor">
    <p>
      {post.admin?.name} |
      {
        new Date(post.updated_at).toLocaleDateString("en-US", {
          day: "numeric",
          month: "long",
          year: "numeric",
        })
      } |
      {post.category?.name}
    </p>
  </div>

  <div class="detail-content">
    <article class="post-body">
      {
        contentParts.map((item, index) =>
          item.type === "html" ? (
            <TableWrapper key={index} htmlContent={item.content} />
          ) : (
            <div
              class="ad-slot"
              data-ad-id={index}
              data-ad-script={encodeURIComponent(item.content)}
            />
          )
        )
      }
    </article>
  </div>
  <PositionAd position="bottom" />
</section>

<section class="related-posts">
  <div class="section-title">
    <h2>Related Posts</h2>
  </div>
  <div class="related-grid">
    {
      relatedPosts.slice(0, 6).map((item) => (
        <div class="related-item" key={item.id}>
          <a href={`/post/${item.slug}`}>
            <img
<<<<<<< HEAD
              src={item.thumbnail || "https://lifennew.com/default.jpg"}
=======
              src={item.thumbnail || "https://newsday.feji.io//default.jpg"}
>>>>>>> 5c42719 (update code domain)
              alt={item.title}
              class="related-img"
            />
            <h3 class="related-title">{item.title}</h3>
          </a>
        </div>
      ))
    }
  </div>
</section>

<script is:client="load">
  document.querySelectorAll(".ad-slot[data-ad-script]").forEach((container) => {
    const raw = decodeURIComponent(
      container.getAttribute("data-ad-script") || ""
    );
    if (!raw.trim()) return;

    container.innerHTML = "";

    const temp = document.createElement("div");
    temp.innerHTML = raw;

    [...temp.childNodes].forEach((node) => {
      if (node.nodeName === "SCRIPT") {
        const script = document.createElement("script");
        [...node.attributes].forEach((attr) =>
          script.setAttribute(attr.name, attr.value)
        );
        script.textContent = node.textContent;
        container.appendChild(script);
      } else {
        container.appendChild(node.cloneNode(true));
      }
    });
  });
</script>
