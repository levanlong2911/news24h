---
import { splitParagraphsWithAds } from "../utils/html.utils.ts";
import { extractScripts } from "../utils/ads.utils.ts";
import PositionAd from "./PositionAd.astro";
import TableWrapper from "../components/TableWrapper.astro";
import type { Post } from "../types.ts";
import { fetchAds } from "../lib/api";
import { injectInPostAds } from "../lib/injectInPostAds";
import type { AdsMap } from "../types/ads"
import { injectAdsByParagraph } from "../utils/injectAdsByParagraph";

const { post, relatedPosts } = Astro.props as {
  post: Post;
  relatedPosts: Post[];
};
// const inPostAds = ads?.["in-post"] || [];
// const { post } = Astro.props as {
//   post: Post;
// };
// ðŸ¤– BOT â†’ NO ADS (SEO CLEAN)
const ua = Astro.request.headers.get("user-agent") || "";
const isBot = /googlebot|bingbot|yandex|duckduckbot|baiduspider/i.test(ua);
const contentHtml = isBot
  ? post.content
  : injectAdsByParagraph(post.content);

// ULTRA PROMAX: inject in-post ads (USER ONLY)
// const contentParts = injectInPostAds(
//   post.content,
//   inPostAds,
//   3
// );
---

<section id="content">
  <!-- ads Banner -->
  <div id="div_adsconex_banner_responsive_1" class="ad-slot"></div>
  <!-- /ads Banner -->
  <div class="detail-title">
    <h1>{post.title}</h1>
  </div>
  <div class="detail-infor">
    <p>
      {post.admin?.name || "Admin"} |
      {new Date(post.updated_at).toLocaleDateString("en-US", {
          day: "numeric",
          month: "long",
          year: "numeric",
        })} |
      {post.category?.name}
    </p>
  </div>
  <!-- video -->
  <div id="adsconex-video-container"></div>
  <!-- /video -->
  <div class="detail-content">
    <article class="post-body">
      <TableWrapper htmlContent={contentHtml} />
    </article>
  </div>
</section>

<section class="related-posts">
  <div class="section-title">
    <h2>Related Posts</h2>
  </div>
  <div class="related-grid">
    {
      relatedPosts.slice(0, 6).map((item) => (
        <div class="related-item" key={item.id}>
          <a href={`/post/${item.slug}`}>
            <img
              src={item.thumbnail}
              alt={item.title}
              class="related-img"
            />
            <h3 class="related-title">{item.title}</h3>
          </a>
        </div>
      ))
    }
  </div>
</section>

