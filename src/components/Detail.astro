---
import type { Post } from "../types.ts";
import PostContent from "../components/PostContent.astro";
import AdsPosition from "../components/ads/AdsPosition.astro";
import type { AdItem } from "../types/ads";

const { post, relatedPosts, ads } = Astro.props as {
  post: Post;
  relatedPosts: Post[];
  ads?: Record<string, AdItem[]>;
};

// üõ°Ô∏è HARD GUARD ‚Äì kh√¥ng cho SSR ch·∫øt
if (!post) {
  return null;
}

const ua = Astro.request.headers.get("user-agent") || "";
const isBot = /googlebot|bingbot|yandex|duckduckbot|baiduspider/i.test(ua);

// üõ°Ô∏è SAFE DATA
const title = post.title || "Untitled";
const content = typeof post.content === "string" ? post.content : "";
const author = post.admin?.name || "Admin";
const category = post.category?.name || "";
const updatedAt = post.updated_at
  ? new Date(post.updated_at).toLocaleDateString("en-US", {
      day: "numeric",
      month: "long",
      year: "numeric",
    })
  : "";

// üõ°Ô∏è SAFE ADS
// const middleAds = Array.isArray(ads?.middle) ? ads!.middle : [];
const inPostAds = Array.isArray(ads?.["in-post"]) ? ads!["in-post"] : [];

// üõ°Ô∏è SAFE RELATED
const safeRelated = Array.isArray(relatedPosts) ? relatedPosts : [];
---

<section id="content">
  <div class="detail-title">
    <h1>{title}</h1>
  </div>
  <div class="detail-infor">
    <p>
      {author}
      {updatedAt ? ` | ${updatedAt}` : ""}
      {category ? ` | ${category}` : ""}
    </p>
  </div>
  <div class="detail-ads-video">
    <ins class="aso-zone" data-zone="110513"></ins>
  </div>
  <div class="detail-content">
    <article class="post-body">
      {isBot ? (
        <div class="table-wrapper post-content" set:html={post.content} />
      ) : (
        <PostContent
          html={content}
          inPostAds={inPostAds}
        />
      )}
    </article>
  </div>
  <AdsPosition position="bottom" ads={ads?.bottom} />
</section>

{safeRelated.length > 0 && (
  <section class="related-posts">
    <div class="section-title">
      <h2>Related Posts</h2>
    </div>

    <div class="related-grid">
      {safeRelated.slice(0, 6).map((item) => {
        const slug = item.slug;
        if (!slug) return null;

        return (
          <div class="related-item" key={item.id}>
            <a href={`/post/${slug}`}>
              <img
                src={item.thumbnail || "/default.jpg"}
                alt={item.title || "Post"}
                class="related-img"
                loading="lazy"
              />
              <h3 class="related-title">
                {item.title || "Untitled"}
              </h3>
            </a>
          </div>
        );
      })}
    </div>
  </section>
)}

