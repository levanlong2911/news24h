---
import Advertisements from '../components/Ads.astro';
import type { Post } from '../types.ts';
import { parseDocument } from 'htmlparser2';
import { DomUtils } from 'htmlparser2';
import { default as serialize } from 'dom-serializer';

const { post, relatedPosts }: { post: Post; relatedPosts: Post[] } = Astro.props;

const baseUrl = Astro.site || import.meta.env.SITE || 'https://admin.lifennew.com';
let ads: string[] = [];

try {
  const res = await fetch(`${baseUrl}/api/ads?position=middle`);
  const json = await res.json();
  ads = json.data.map((item: any) => item.script);
} catch (err) {
  console.error("Ads fetch error:", err);
}

// SSR parse HTML content and inject ads every 2 <p>
const document = parseDocument(post.content || '');
const bodyNodes = DomUtils.getChildren(document) || [];
const resultNodes: any[] = [];

let pCounter = 0;
let adIndex = 0;

for (const node of bodyNodes) {
  resultNodes.push(node);

  if (node.type === 'tag' && node.name === 'p') {
    pCounter++;
    if (pCounter % 2 === 0 && ads[adIndex]) {
      const adFragment = parseDocument(`<div class="ad-container">${ads[adIndex++]}</div>`);
      resultNodes.push(...DomUtils.getChildren(adFragment));
    }
  }
}

document.children = resultNodes;
const injectedHtml = serialize(document);
---

<Advertisements position="top" />

<section id="content">
  <div class="detail-title">
    <h1>{post.title}</h1>
  </div>
  <div class="detail-infor">
    <p>
      {post.admin?.name} |
      {new Date(post.updated_at).toLocaleDateString("en-US", {
        day: "numeric",
        month: "long",
        year: "numeric",
      })} |
      {post.category?.name}
    </p>
  </div>

  <div class="detail-content">
    <article class="post-body" set:html={injectedHtml} />
  </div>
</section>

<Advertisements position="bottom" />

<section class="related-posts">
  <div class="section-title">
    <h2>Related Posts</h2>
  </div>
  <div class="related-grid">
    {relatedPosts.slice(0, 6).map((item) => (
      <div class="related-item" key={item.id}>
        <a href={`/post/${item.slug}`}>
          <img
            src={item.thumbnail || "https://lifennew.com/default.jpg"}
            alt={item.title}
            class="related-img"
          />
          <h3 class="related-title">{item.title}</h3>
        </a>
      </div>
    ))}
  </div>
</section>