---
import PositionAd from "../components/PositionAd.astro";
import type { Post } from "../types.ts";

interface Props {
  posts?: Post[];
  ads?: Record<string, any[]>;
}

const { posts, ads }: Props = Astro.props;

const safePosts: Post[] = Array.isArray(posts) ? posts : [];
const inPostAds = ads?.["in-post"] || [];

// base url an toàn (không dùng WEB_BASE)
const BASE_URL = import.meta.env.PUBLIC_API_WEB || "";
---

<section id="content">
  {
    safePosts.length === 0 && (
      <p>No posts available.</p>
    )
  }

  {
    safePosts.map((post: Post, index: number) => {
      const slug = post.slug ?? "";
      if (!slug) return null;

      const title = post.title ?? "Untitled";
      const thumbnail =
        post.thumbnail || "${BASE_URL}/default.jpg";

      const description =
        post.content
          ?.replace(/<\/?[^>]+(>|$)/g, "")
          ?.slice(0, 150) + "...";

      return (
        <>
          <div class="grid-content">
            <div class="post-img">
              <a href={`/post/${slug}`} title={title}>
                <img
                  src={thumbnail}
                  alt={title}
                  loading="lazy"
                  decoding="async"
                />
              </a>
            </div>

            <div class="posts-title">
              <div class="content-title">
                <a href={`/post/${slug}`} title={title}>
                  <h3 class="text-black font-bold">{title}</h3>
                </a>
              </div>

              <div class="content-date">
                <span>
                  {post.admin?.name || "Admin"},{" "}
                  {post.updated_at
                    ? new Date(post.updated_at).toLocaleDateString("en-US", {
                        day: "numeric",
                        month: "long",
                        year: "numeric",
                      })
                    : ""}
                  {post.category?.name ? `, ${post.category.name}` : ""}
                </span>
              </div>

              <div class="content-description">
                <p>{description}</p>
              </div>
            </div>
          </div>

          {(index + 1) % 2 === 0 && inPostAds.length  && (
            <div class="grid-content in-post-ad full-width-ad">
              <PositionAd position="in-post" ads={ads} />
            </div>
          )}
        </>
      );
    })
  }
</section>
