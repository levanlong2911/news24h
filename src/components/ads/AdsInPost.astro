---
import type { AdItem } from "../../types/ads";

const { html, ads } = Astro.props as {
  html: string;
  ads: AdItem[];
};

let index = 0;

const injected = html.replace(/(<p[\s\S]*?<\/p>){2}/g, match => {
  if (!ads[index]) return match;
  const encoded = encodeURIComponent(ads[index].script);
  index++;
  return `
    ${match}
    <div class="ad-in-post" data-ad-script="${encoded}"></div>
  `;
});
---

<div class="post-content" set:html={injected}></div>

<script is:client="load">
  document
    .querySelectorAll(".ad-in-post[data-ad-script]")
    .forEach(el => {
      const html = decodeURIComponent(el.dataset.adScript || "");
      el.innerHTML = "";
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      while (tmp.firstChild) el.appendChild(tmp.firstChild);
    });
</script>
