---
import type { AdItem, AdsPosition } from "../../types/ads";

const { position, ads } = Astro.props as {
  position: AdsPosition;
  ads?: AdItem[];
};

const items = Array.isArray(ads)
  ? ads.filter(a => typeof a?.script === "string" && a.script.trim())
  : [];

const hasAds = items.length > 0;
---
{hasAds && (
  <div class={`ad ad-${position}`}>
    {items.map(item => (
      <div
        class="ad-slot"
        data-ad-script={encodeURIComponent(item.script)}
      ></div>
    ))}
  </div>
)}
{hasAds && (
  <script is:client="load">
    document.querySelectorAll(".ad-slot[data-ad-script]").forEach(el => {
      if (el.dataset.loaded === "1") return;

      const raw = el.dataset.adScript;
      if (!raw) return;

      el.dataset.loaded = "1";

      try {
        const html = decodeURIComponent(raw);
        const tmp = document.createElement("div");
        tmp.innerHTML = html;

        // nếu script không sinh ra gì → ẩn luôn
        el.innerHTML = "";
        while (tmp.firstChild) el.appendChild(tmp.firstChild);

        if (!el.firstChild) {
          el.closest(".ad")?.remove();
        }
      } catch (e) {
        el.closest(".ad")?.remove();
      }
    });
  </script>
)}


