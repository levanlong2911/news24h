---
import type { AdItem, AdsPosition } from "../../types/ads";

const { position, ads } = Astro.props as {
  position: AdsPosition;
  ads?: AdItem[];
};

const items = Array.isArray(ads)
  ? ads.filter(a => typeof a?.script === "string" && a.script.trim())
  : [];

const hasAds = items.length > 0;
---

{hasAds && (
  <>
    {items.map(item => (
      <div
        class={`ad-slot ad-${position}`}
        data-ad-script={encodeURIComponent(item.script)}
      ></div>
    ))}

    <script is:client="load">
      document.querySelectorAll(
        '.ad-slot[data-ad-script]:not([data-loaded="1"])'
      ).forEach(el => {
        const raw = el.dataset.adScript;
        if (!raw) return;

        el.dataset.loaded = "1";

        try {
          const html = decodeURIComponent(raw);
          const tmp = document.createElement("div");
          tmp.innerHTML = html;

          el.innerHTML = "";
          while (tmp.firstChild) {
            el.appendChild(tmp.firstChild);
          }

          // ❌ network không bơm DOM → remove slot
          if (!el.firstChild) {
            el.remove();
          }
        } catch (e) {
          el.remove();
        }
      });
    </script>
  </>
)}
