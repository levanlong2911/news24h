---
// src/pages/post/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import Detail from '../../components/Detail.astro';
import Sidebar from '../../components/Sidebar.astro';
import type { Post } from '../../types';
import { fetchPostDetail, fetchPosts, fetchAds, webLink } from '../../lib/api';

const { slug } = Astro.params;

// Fallback
const emptyPost = null;
const emptyList: Post[] = [];
const emptyAds = {};

// Parallel fetch: post detail, sidebar posts, ads
const [postData, posts, ads] = await Promise.all([
  fetchPostDetail(slug),
  fetchPosts(),
  fetchAds(),
]);

// Nếu post null → trả 404 SEO-safe
if (!postData || !postData.post) {
  return new Response(null, { status: 404 });
}

const post: Post = postData.post;
const relatedPosts: Post[] = postData.related_posts || [];

const siteUrl = import.meta.env.PUBLIC_API_WEB.replace(/\/$/, '');

// Helpers SEO-safe
const pageTitle = post.title;
const pageDescription = post.description || post.title || 'Default Description';
const pageImage = post.thumbnail || webLink('default.jpg');
const pageUrl = `${siteUrl}/post/${post.slug}`;
const publishedAt = post.created_at || '';
const updatedAt = post.updated_at || post.created_at || '';
const authorName = post.admin?.name || 'Unknown Author';
---

<BaseLayout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  pageImage={pageImage}
  pageUrl={pageUrl}
  isArticle={true}
  publishedAt={publishedAt}
  updatedAt={updatedAt}
  authorName={authorName}
>
  <div class="grid-container">
    <Detail post={post} relatedPosts={relatedPosts} ads={ads} />
    <Sidebar posts={posts} />
  </div>
</BaseLayout>
