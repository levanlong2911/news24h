---
// src/pages/post/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import Detail from '../../components/Detail.astro';
import Sidebar from '../../components/Sidebar.astro';
import type { Post } from '../../types';
import { fetchPostDetail, fetchPosts, fetchAds } from '../../lib/api';
import NotFound from '../404.astro';

const { slug } = Astro.params;
if (!slug) {
  return Astro.rewrite('/404', { status: 404 });
}

// Fallback
const emptyList: Post[] = [];
let postData: {
  post?: Post;
  related_posts?: Post[];
} | null = null;
let postsRes: any = null;
let ads: any = {};

// PROMAX: không bao giờ throw
try {
  const results = await Promise.allSettled([
    fetchPostDetail(slug),
    fetchPosts(1, 'v1'),
    fetchAds(),
  ]);

  // post detail (QUAN TRỌNG NHẤT)
  if (results[0].status === 'fulfilled') {
    postData = results[0].value;
  }

  // sidebar posts
  if (results[1].status === 'fulfilled') {
    postsRes = results[1].value;
  }

  // ads
  if (results[2].status === 'fulfilled') {
    ads = results[2].value || {};
  }
} catch {
  // ❗ tuyệt đối không throw
}

// ❗ nếu không có post → 404 SEO-safe
if (!postData || !postData.post) {
  return Astro.rewrite('/404', { status: 404 });
}

const post: Post = postData.post;
const relatedPosts: Post[] = postData.related_posts ?? [];
const posts: Post[] = postsRes?.items ?? emptyList;

const siteUrl = import.meta.env.PUBLIC_API_WEB.replace(/\/$/, '');

// Helpers SEO-safe
const pageTitle = post.title;
const pageDescription = post.description || post.title;
const pageImage = post.thumbnail || '/default.jpg';
const pageUrl = `${siteUrl}/post/${post.slug}`;
const publishedAt = post.created_at || '';
const updatedAt = post.updated_at || post.created_at || '';
const authorName = post.admin?.name || 'Unknown Author';
---

<BaseLayout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  pageImage={pageImage}
  pageUrl={pageUrl}
  isArticle={true}
  publishedAt={publishedAt}
  updatedAt={updatedAt}
  authorName={authorName}
  ads={ads}
>
  <div class="grid-container">
    <Detail post={post} relatedPosts={relatedPosts} ads={ads} />
    <Sidebar posts={posts} />
  </div>
</BaseLayout>
