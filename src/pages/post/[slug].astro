---
// src/pages/post/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import Detail from '../../components/Detail.astro';
import Sidebar from '../../components/Sidebar.astro';
import type { Post } from '../../types';
import { fetchPostDetail, fetchPosts, fetchAds } from '../../lib/api';
// import NotFound from '../404.astro';


export async function getStaticPaths() {
  const res = await fetch(
    `${import.meta.env.PUBLIC_API_WEB}/posts/slugs`,
    {
      headers: {
        Accept: 'application/json',
        'X-Api-Key': import.meta.env.PUBLIC_API_KEY,
      },
    }
  );

  const json = await res.json();
  const slugs: string[] = json?.data ?? [];

  return slugs.map((slug) => ({
    params: { slug },
  }));
}


const { slug } = Astro.params;
if (!slug) {
  return Astro.rewrite('/404', { status: 404 });
}

// Fallback
const emptyList: Post[] = [];
let postData: {
  post?: Post;
  related_posts?: Post[];
} | null = null;
let postsRes: any = null;
let ads: any = {};

// PROMAX: không bao giờ throw
try {
  const [detail, posts, adsRes] = await Promise.allSettled([
    fetchPostDetail(slug),
    fetchPosts(1, 'v1'),
    fetchAds(),
  ]);

  if (detail.status === 'fulfilled') {
    postData = detail.value;
  }

  if (posts.status === 'fulfilled') {
    postsRes = posts.value;
  }

  if (adsRes.status === 'fulfilled') {
    ads = adsRes.value || {};
  }
} catch {
  // không làm gì cả
}

// ❗ Không có post → rewrite 404 (SEO + Facebook + Cloudflare SAFE)
if (!postData?.post) {
  return Astro.rewrite('/404', { status: 404 });
}

const post: Post = postData.post;
const relatedPosts: Post[] = postData.related_posts ?? [];
const posts: Post[] = postsRes?.items ?? emptyList;

const siteUrl = import.meta.env.PUBLIC_API_WEB.replace(/\/$/, '');

// Helpers SEO-safe
const pageTitle = post.title;
const pageDescription = post.description || post.title;
const pageImage = post.thumbnail || '/default.jpg';
const pageUrl = `${siteUrl}/post/${post.slug}`;
const publishedAt = post.created_at || '';
const updatedAt = post.updated_at || post.created_at || '';
const authorName = post.admin?.name || 'Unknown Author';
---

<BaseLayout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  pageImage={pageImage}
  pageUrl={pageUrl}
  isArticle={true}
  publishedAt={publishedAt}
  updatedAt={updatedAt}
  authorName={authorName}
  ads={ads}
>
  <div class="grid-container">
    <Detail post={post} relatedPosts={relatedPosts} ads={ads} />
    <Sidebar posts={posts} />
  </div>
</BaseLayout>
